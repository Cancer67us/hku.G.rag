<!DOCTYPE html>
<html lang="en">
<head>
    <title>Chat</title>
</head>
<body>
<h1>Chat with Locally Deployed LLM</h1>
<form action="" onsubmit="return false;" id="form">
    <label for="messageText"></label>
    <input type="text" id="messageText" autocomplete="on"/>
    <button type="submit">Send</button>
</form>
<ul id='messageBox'>
</ul>
<script>
    let ws = new WebSocket("ws://" + location.host + "/ws");
    let history = [];
    let last_message_element = null;

    function appendMessage(text, sender, inference_time, dom = null) {
        if (dom === null) {
            let messageBox = document.getElementById('messageBox');
            dom = document.createElement('li');
            messageBox.appendChild(dom);
        }
        // 确保inference_time不是null或undefined
        let timeStr = inference_time ? `(inference time: ${inference_time} seconds)` : '';
        let message = sender + timeStr + ': ' + text;
        dom.innerText = message;
        return dom;
    }

    function sendMessage(event) {
        if (last_message_element !== null) {  
            return;
        }
        let input = document.getElementById("messageText");
        if (input.value === "") {
            return;
        }
        let body = {"query": input.value, 'history': history};
        ws.send(JSON.stringify(body));
        appendMessage(input.value, '7506 Student')
        input.value = '';
        event.preventDefault();
    }

    document.getElementById("form").addEventListener('submit', sendMessage)


    ws.onmessage = function (event) {
    let body = JSON.parse(event.data);
    let status = body['status'];
    if (status === 200) {
        let inference_time = body['inference_time'];
        // Append the final message with the total inference time
        appendMessage(body['response'], 'LLM', inference_time, last_message_element);
        last_message_element = null; // Reset for the next message
    } else {
        history = body['history'];
        last_message_element = appendMessage(body['response'], 'LLM', null, last_message_element);
    }
    }; 

</script>
</body>
</html>